<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CKP Cloud Sync Test</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0f1115;color:#e8ecf1;margin:0;padding:24px}
    .card{max-width:720px;background:#131722;border:1px solid #273042;border-radius:16px;padding:18px}
    label{display:block;margin:12px 0 6px;color:#a7b0bd}
    input{width:320px;max-width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:#e8ecf1}
    button{padding:10px 12px;border-radius:12px;border:none;background:rgba(255,255,255,.15);color:#e8ecf1;cursor:pointer;margin-right:8px}
    button:hover{background:rgba(255,255,255,.22)}
    .msg{margin-top:14px;color:#a7b0bd;white-space:pre-wrap}
    .ok{color:#7CFC98}
    .bad{color:#ff8a8a}
    .tiny{font-size:12px}
  </style>
</head>
<body>
  <div class="card">
    <h2 style="margin:0 0 12px">CKP Cloud Sync Test</h2>

    <label>Month Key:</label>
    <input id="monthKey" value="2026-01" />

    <label>Test Value:</label>
    <input id="testValue" placeholder="Type something" />

    <div style="margin-top:14px">
      <button id="saveBtn">Save to Supabase</button>
      <button id="loadBtn">Load from Supabase</button>
    </div>

    <div id="msg" class="msg tiny"></div>
  </div>

  <!-- Load Supabase ONE TIME -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ====== CONFIG (yours) ======
    const SUPABASE_URL = "https://ephkcxaggqspklvywxpl.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_I86rCHvEzTwfScSzZ4hV7Q_J6oJbC64";

    // Create client ONE TIME
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Make a stable device id
    const DEVICE_ID_KEY = "ckp:deviceId";
    const DEVICE_ID =
      localStorage.getItem(DEVICE_ID_KEY) ||
      (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2));
    localStorage.setItem(DEVICE_ID_KEY, DEVICE_ID);

    const msgEl = document.getElementById("msg");
    const setMsg = (text, ok=true) => {
      msgEl.textContent = text;
      msgEl.className = "msg tiny " + (ok ? "ok" : "bad");
    };

    async function saveData() {
      const month_key = document.getElementById("monthKey").value.trim();
      const value = document.getElementById("testValue").value;

      if (!month_key) return setMsg("Month Key is blank", false);

      const payload = {
        testValue: value,
        savedAt: new Date().toISOString()
      };

      const { error } = await supabaseClient
        .from("ckp_months")
        .upsert(
          { user_id: DEVICE_ID, month_key, payload },
          { onConflict: "user_id,month_key" }
        );

      if (error) return setMsg("SAVE failed:\n" + error.message, false);
      setMsg("SAVE ok ✅\nuser_id=" + DEVICE_ID + "\nmonth_key=" + month_key);
    }

    async function loadData() {
      const month_key = document.getElementById("monthKey").value.trim();
      if (!month_key) return setMsg("Month Key is blank", false);

      const { data, error } = await supabaseClient
        .from("ckp_months")
        .select("payload, updated_at")
        .eq("user_id", DEVICE_ID)
        .eq("month_key", month_key)
        .maybeSingle();

      if (error) return setMsg("LOAD failed:\n" + error.message, false);
      if (!data) return setMsg("No row found for that month_key on this device id.\nTry saving first.", false);

      document.getElementById("testValue").value = data.payload?.testValue ?? "";
      setMsg("LOAD ok ✅\nupdated_at=" + data.updated_at + "\npayload=" + JSON.stringify(data.payload, null, 2));
    }

    document.getElementById("saveBtn").addEventListener("click", saveData);
    document.getElementById("loadBtn").addEventListener("click", loadData);

    setMsg("Ready. Device ID:\n" + DEVICE_ID);
  </script>
</body>
</html>
