<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CKP Pay Hours</title>
<style>
:root{--bg:#0f1115;--panel:#131722;--text:#e8ecf1;--muted:#a7b0bd;--line:#273042;--accent:#6aa8ff;--top:#5a2b8a}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
.topbar{position:sticky;top:0;z-index:20;display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--top);border-bottom:1px solid rgba(255,255,255,.08)}
.brand{font-weight:900}
.actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
select,button,input{font:inherit}
select{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);color:var(--text);padding:8px 10px;border-radius:10px;outline:none}
button{border:none;background:rgba(255,255,255,.15);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;white-space:nowrap}
button:hover{background:rgba(255,255,255,.22)}
button.ghost{background:rgba(255,255,255,.08)}button.ghost:hover{background:rgba(255,255,255,.14)}

.layout{display:grid;grid-template-columns:1fr 420px;gap:16px;padding:16px}
@media(max-width:1180px){.layout{grid-template-columns:1fr}.right{order:-1}}

.monthTitle{font-size:18px;font-weight:900;margin:0 0 10px}
.tableWrap{background:var(--panel);border:1px solid var(--line);border-radius:16px;overflow:auto}
.grid{display:grid;grid-template-columns:70px 160px 105px 165px 105px 110px 110px 110px;align-items:center}
.header{background:rgba(255,255,255,.06);font-size:12px;font-weight:900;position:sticky;top:0;z-index:10}
.header>div,.footer>div{padding:12px 10px;border-right:1px solid rgba(255,255,255,.06)}
.header>div:last-child,.footer>div:last-child{border-right:none}
.row{border-top:1px solid rgba(255,255,255,.06)}
.cell{padding:10px;border-right:1px solid rgba(255,255,255,.06)}
.cell:last-child{border-right:none}
.datePill{display:inline-flex;align-items:center;justify-content:center;width:34px;height:24px;border:2px solid var(--accent);border-radius:6px;font-weight:900;background:rgba(106,168,255,.06)}
select.codeSel,input.baseInp{width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:var(--text);padding:8px;border-radius:10px;outline:none}
input.baseInp{text-align:right;font-variant-numeric:tabular-nums}
.num{text-align:right;font-variant-numeric:tabular-nums}
.muted{color:var(--muted)}
.note{margin-top:10px;color:var(--muted);font-size:13px}
.footer{background:rgba(255,255,255,.04);font-weight:900}

.card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px}
.pilot{padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,.07)}
.pilotName{font-size:22px;font-weight:900}
.pilotId{color:var(--muted);margin-top:2px}
.pilotMeta{display:flex;gap:18px;margin-top:10px;color:var(--muted);flex-wrap:wrap}
.metaVal{color:var(--text);font-weight:900;margin-top:2px}
.summary{margin-top:12px}
.sumRow{display:flex;justify-content:space-between;align-items:center;padding:8px 0}
.sumRow.indent{padding-left:16px;color:rgba(255,255,255,.88)}
.sumRow.total{font-size:18px;font-weight:950}
.divider{height:1px;background:rgba(255,255,255,.10);margin:8px 0}

.netMini{margin-top:10px;border-top:1px solid rgba(255,255,255,.07);padding-top:10px}
.netChip{display:flex;justify-content:space-between;align-items:center;background:rgba(106,168,255,.10);border:1px solid rgba(106,168,255,.35);border-radius:12px;padding:10px 12px;margin-top:8px}
.netChip .lbl{font-weight:900}
.netChip .val{font-variant-numeric:tabular-nums;font-weight:950}

details summary{cursor:pointer}
.settingsGrid{margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
.settingsGrid label{display:flex;flex-direction:column;gap:4px;font-size:12px}
.settingsGrid input{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:var(--text);padding:8px;border-radius:10px;outline:none}
.small{font-size:12px}
.shfsSel{background:transparent;border:none;color:var(--text);font-weight:900;padding:0;outline:none}

.pillRow{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
.pill{display:flex;flex-direction:column;gap:4px;font-size:12px;color:var(--muted)}
.pill select,.pill input{padding:6px 8px;border-radius:10px;min-width:120px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:var(--text)}
.pill input{text-align:right}

.financeWrap{margin-top:16px;background:var(--panel);border:1px solid var(--line);border-radius:16px;overflow:auto}
.financeTitle{padding:12px 12px 0 12px;font-weight:900}
.finGrid{display:grid;grid-template-columns:200px 135px 135px 135px 135px 135px;align-items:center}
.finHead{background:rgba(255,255,255,.06);font-size:12px;font-weight:900;position:sticky;top:0}
.finCell{padding:10px;border-top:1px solid rgba(255,255,255,.06);border-right:1px solid rgba(255,255,255,.06)}
.finCell:last-child{border-right:none}
.finLabel{color:var(--muted);font-weight:800}
.finNet{background:rgba(106,168,255,.14)}
.finNet .finCell{border-top:1px solid rgba(106,168,255,.35)}
.finNet .finLabel{color:rgba(255,255,255,.92);font-weight:950}
.inlineInput{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 12px 0 12px}
.inlineInput input{width:170px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:var(--text);padding:8px;border-radius:10px;outline:none}
.kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;color:rgba(255,255,255,.85)}
</style>
</head>
<body>
<header class="topbar">
  <div class="brand">CKP Pay Hours</div>
  <div class="actions">
    <select id="monthSelect"></select>
    <button id="backupBtn">Backup JSON</button>
    <button id="restoreBtn">Restore JSON</button>
    <button id="exportBtn">Export CSV</button>
    <button id="resetBtn" class="ghost">Reset month</button>
    <input id="restoreFile" type="file" accept="application/json" style="display:none"/>
  </div>
</header>
<main class="layout">
  <section class="left">
    <div class="monthTitle" id="monthTitle"></div>
    <div class="tableWrap">
      <div class="grid header">
        <div>Date</div><div>Code</div><div>Count</div>
        <div>Base (hh:mm)</div><div>Base (dec)</div>
        <div>+2.5</div><div>Override</div><div>Total</div>
      </div>
      <div id="rows"></div>
      <div class="grid footer">
        <div class="muted">Totals</div><div></div>
        <div class="num" id="totDays">0</div>
        <div class="muted num">—</div>
        <div class="num" id="totBase">0.00</div>
        <div class="num" id="totOT">0.00</div>
        <div class="num" id="totOV">0.00</div>
        <div class="num" id="totTotal">0.00</div>
      </div>
    </div>

    <div class="financeWrap">
      <div class="financeTitle">Finance Summary (Dollars)</div>
      <div class="inlineInput">
        <div class="muted">Other Taxable (True-Up only):</div>
        <input id="otherTaxable" type="number" step="0.01" value="0"/>
        <div class="muted small">Per diem / sit time / misc paid on True-Up</div>
      </div>
      <div class="finGrid finHead" style="margin-top:10px">
        <div class="finCell finLabel"></div>
        <div class="finCell finLabel">Advance</div>
        <div class="finCell finLabel">True-Up</div>
        <div class="finCell finLabel">Month</div>
        <div class="finCell finLabel">YTD</div>
        <div class="finCell finLabel">Prev YTD</div>
      </div>
      <div id="financeRows"></div>
    </div>

    <div class="note">
      Time entry: type <span class="kbd">8:27</span> (or <span class="kbd">8.45</span>). It saves on this device. Use Backup/Restore to move data between phone/computer.
    </div>
  </section>

  <aside class="right">
    <div class="card">
      <div class="pilot">
        <div class="pilotName">Robert Tate</div>
        <div class="pilotId">ID: 751597</div>

        <div class="pilotMeta">
          <div><span class="muted">Fleet</span><div class="metaVal">737</div></div>
          <div>
            <span class="muted">SH/FS</span>
            <div class="metaVal">
              <select id="shfsSelect" class="shfsSel">
                <option value="FS">FS</option>
                <option value="SH">SH</option>
              </select>
            </div>
          </div>
        </div>

        <div class="pillRow">
          <div class="pill">
            <span>Line Rotation?</span>
            <select id="lrSelect"><option value="No">No</option><option value="Yes">Yes</option></select>
          </div>
          <div class="pill">
            <span>Union Dues?</span>
            <select id="udSelect"><option value="No">No</option><option value="Yes">Yes</option></select>
          </div>
        </div>
      </div>

      <div class="summary">
        <div class="sumRow"><div>Pilots Regular Pay</div><div class="num" id="sumRegular">0.00</div></div>
        <div class="sumRow"><div>CKP Day Adjustment</div><div class="num" id="sumDayAdj">0.00</div></div>
        <div class="sumRow"><div>CKP Add'l Day Premium (2.5)</div><div class="num" id="sumAddl">0.00</div></div>
        <div class="sumRow"><div>CKP Duties (Override)</div><div class="num" id="sumOverride">0.00</div></div>
        <div class="sumRow indent"><div><i>Prem on OT</i></div><div class="num" id="sumPremOT">0.00</div></div>
        <div class="divider"></div>
        <div class="sumRow total"><div>Total Hours</div><div class="num" id="sumGrand">0.00</div></div>

        <div class="netMini">
          <div class="muted small">NET (Dollars)</div>
          <div class="netChip"><div class="lbl">Advance</div><div class="val" id="netAdvMini">$0.00</div></div>
          <div class="netChip"><div class="lbl">True-Up</div><div class="val" id="netTrueMini">$0.00</div></div>
        </div>
      </div>

      <details class="settings">
        <summary>Settings</summary>
        <div class="settingsGrid">
          <label><span>Contract Year</span><input id="contractYear" type="number" step="1"/></label>
          <label><span>Pay rate ($/hr)</span><input id="payRate" type="number" step="0.01"/></label>

          <label><span>Daily guarantee (hrs)</span><input id="daily" type="number" step="0.01"/></label>
          <label><span>Regular pay (hrs)</span><input id="regHours" type="number" step="0.01"/></label>

          <label><span>Override %</span><input id="ovpct" type="number" step="0.01"/></label>
          <label><span>Line rotation %</span><input id="lrovr" type="number" step="0.01"/></label>

          <label><span>OT after day</span><input id="otAfter" type="number" step="1"/></label>
          <label><span>OT prem hours</span><input id="otPrem" type="number" step="0.01"/></label>

          <label><span>Vacation hrs/day</span><input id="vacHrs" type="number" step="0.0001"/></label>
          <label><span>Sick hrs/day</span><input id="sickHrs" type="number" step="0.0001"/></label>

          <label><span>DC %</span><input id="dcPct" type="number" step="0.001"/></label>
          <label><span>DC comp cap</span><input id="dcCap" type="number" step="1"/></label>

          <label><span>Union dues %</span><input id="unionPct" type="number" step="0.001"/></label>
          <label><span>Pre-tax / check</span><input id="preTaxPP" type="number" step="0.01"/></label>

          <label><span>After-tax / check</span><input id="afterTaxPP" type="number" step="0.01"/></label>
          <label><span>After-tax extra</span><input id="afterTaxExtra" type="number" step="0.01"/></label>

          <label><span>Medicare rate</span><input id="medRate" type="number" step="0.0001"/></label>
          <label><span>Add'l Med rate</span><input id="addMedRate" type="number" step="0.0001"/></label>

          <label><span>Add'l Med thresh</span><input id="addMedThresh" type="number" step="1"/></label>
          <label><span>SS rate</span><input id="ssRate" type="number" step="0.0001"/></label>

          <label><span>SS wage base</span><input id="ssWageBase" type="number" step="1"/></label>
          <label><span>Gross YTD seed</span><input id="grossSeed" type="number" step="0.01"/></label>

          <label><span>NET YTD seed</span><input id="netSeed" type="number" step="0.01"/></label>
          <label style="grid-column:1/-1"><span>Codes (comma)</span><input id="codeList" type="text"/></label>
        </div>
        <div class="muted small" style="margin-top:8px;line-height:1.35">
          Finance: Fed uses FedRate_Linear LOOKUP. Social Sec is capped. Add'l Medicare uses threshold. Other Taxable only applies to True-Up.
        </div>
      </details>
    </div>
  </aside>
</main>

<script src="./fed_table.js"></script>
<script>
(() => {
  const ROWS_PER_MONTH = 31;
  const FED_TABLE = window.FED_TABLE;
  const DEFAULTS = {"contractYear": 2026, "payRate": 390.3, "daily": 6.0, "ovpct": 0.2, "lrOvr": 0.25, "vacHrs": 4.5833333333, "sickHrs": 6.0, "dcPct": 0.18, "dcCap": 360000.0, "preTaxPP": 569.64, "afterTaxPP": 250.57, "afterTaxExtra": 471.21, "unionPct": 0.01, "unionOnDefault": "No", "medRate": 0.0145, "addMedRate": 0.009, "addMedThresh": 200000.0, "ssRate": 0.062, "ssWageBase": 184500.0, "grossYTDSeed": 45712.85, "netYTDSeed": 28500.46, "regularPayHours": 90.0, "otAfterDay": 15, "otPremHours": 2.5, "codes": ["", "LC", "NH", "UG", "UGI", "WDAY", "Training", "Stan Meeting", "WKCXLD", "Vacation", "Sick"], "noOverrideCodes": ["WDAY", "Training", "Stan Meeting", "Vacation", "Sick", "WKCXLD"], "noCountCodes": ["Vacation", "Sick", "WKCXLD"]};

  const $ = id => document.getElementById(id);
  const monthSelect = $("monthSelect");
  const rowsEl = $("rows");
  const financeRowsEl = $("financeRows");
  const shfsSelect = $("shfsSelect");
  const lrSelect = $("lrSelect");
  const udSelect = $("udSelect");
  const otherTaxableInp = $("otherTaxable");

  const settingsKey = "ckp:settings:vFinal";
  const monthKey = k => `ckp:month:vFinal:${k}`;

  const fmt2 = x => (Math.round(x * 100) / 100).toFixed(2);
  const money = x => (Math.round(x * 100) / 100).toLocaleString(undefined,{style:"currency",currency:"USD"});
  const pad2 = n => String(n).padStart(2,"0");
  const keyFor = (y,m) => `${y}-${pad2(m)}`;
  const labelFor = k => {
    const [y,m]=k.split("-").map(Number);
    const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    return `${months[m-1]} ${y}`;
  };

  function parseHours(input){
    const s = String(input ?? "").trim();
    if(!s) return 0;
    if(s.includes(":")){
      const [h,m]=s.split(":");
      const hh=Number(h), mm=Number(m);
      if(Number.isFinite(hh)&&Number.isFinite(mm)) return hh + (mm/60);
      return 0;
    }
    const v=Number(s);
    return Number.isFinite(v) ? v : 0;
  }

  function loadSettings(){
    try{
      const raw=localStorage.getItem(settingsKey);
      if(!raw) return structuredClone(DEFAULTS);
      const s=JSON.parse(raw)||{};
      const out=structuredClone(DEFAULTS);
      Object.assign(out,s);
      if(typeof out.codes==="string"){
        const parts=out.codes.split(",").map(x=>x.trim()).filter(x=>x.length>0);
        if(parts[0]!== "") parts.unshift("");
        out.codes=parts;
      }
      return out;
    }catch{ return structuredClone(DEFAULTS); }
  }
  const saveSettings = s => localStorage.setItem(settingsKey, JSON.stringify({...s, codes:s.codes.join(",")}));

  function initMonths(contractYear){
    const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    monthSelect.innerHTML = months.map((m,i)=>`<option value="${keyFor(contractYear,i+1)}">${m} ${contractYear}</option>`).join("");
    return keyFor(contractYear,1);
  }

  const blankMonth = () => ({
    shfs:"FS",
    lineRotation:"No",
    unionDues: DEFAULTS.unionOnDefault || "No",
    otherTaxable: 0,
    rows: Array.from({length:ROWS_PER_MONTH},(_,i)=>({day:i+1, code:"", base:""}))
  });

  function loadMonth(k){
    const raw=localStorage.getItem(monthKey(k));
    if(!raw) return blankMonth();
    try{
      const p=JSON.parse(raw)||{};
      const rows=Array.from({length:ROWS_PER_MONTH},(_,i)=>{
        const day=i+1;
        const found=(p.rows||[]).find(r=>r.day===day) || {day,code:"",base:""};
        return {day, code: found.code ?? "", base: found.base ?? ""};
      });
      return {shfs:p.shfs||"FS", lineRotation:p.lineRotation||"No", unionDues:p.unionDues||DEFAULTS.unionOnDefault||"No", otherTaxable:Number(p.otherTaxable||0), rows};
    }catch{ return blankMonth(); }
  }
  const saveMonth = (k,d) => localStorage.setItem(monthKey(k), JSON.stringify(d));

  function lookupFedRate(x){
    // Match Excel LOOKUP(A2:A300,B2:B300) behavior on the sheet's ROW ORDER (range isn't fully sorted).
    // Excel returns the LAST threshold <= x encountered while scanning top-to-bottom.
    let rate = 0;
    for(const [thr, r] of FED_TABLE){
      if(x >= thr) rate = r;
    }
    return rate;
  }



  function isCountDay(code, baseDec){
    const c=(code||"").trim();
    if(DEFAULTS.noCountCodes.includes(c)) return false;
    if(c==="WDAY"||c==="Training"||c==="Stan Meeting") return true;
    return baseDec>0;
  }

  function baseHoursFor(code, baseDec, s){
    const c=(code||"").trim();
    if(c==="Vacation") return s.vacHrs;
    if(c==="Sick") return s.sickHrs;
    if(c==="WDAY"||c==="Training"||c==="Stan Meeting"||c==="WKCXLD") return s.daily;
    return baseDec>0 ? baseDec : 0;
  }

  function overrideBlocked(code){
    const c=(code||"").trim();
    return DEFAULTS.noOverrideCodes.includes(c);
  }

  function computeRows(rows, s, md){
    const isLR = md.lineRotation==="Yes";
    const ovrPct = isLR ? s.lrOvr : s.ovpct;
    let count=0;
    return rows.map(r=>{
      const baseDec=parseHours(r.base);
      const code=(r.code||"").trim();
      const counted = isCountDay(code, baseDec);
      if(counted) count++;

      const baseHrs=baseHoursFor(code, baseDec, s);
      const add25 = (count > s.otAfterDay && baseHrs>0 && !DEFAULTS.noCountCodes.includes(code)) ? s.otPremHours : 0;

      const ov = (!overrideBlocked(code) && baseHrs>0) ? baseHrs*ovrPct : 0;
      const premOT = add25*ovrPct;
      const total = baseHrs + add25 + ov + premOT;
      return {...r, baseDec, baseHrs, add25, ov, premOT, total, count: counted ? 1 : 0};
    });
  }

  const max0=x=>Math.max(0,x);
  const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
  const incCap=(rate, cap, ytdNew, period)=> rate*max0(clamp(ytdNew,0,cap)-clamp(ytdNew-period,0,cap));
  const incAbove=(rate, thresh, ytdNew, period)=> rate*(max0(ytdNew-thresh)-max0((ytdNew-period)-thresh));

  function computeFinance(s, md, totalHours){
    const advHours=45;
    const tuHours=max0(totalHours-advHours);

    const wageAdv = s.payRate*advHours;
    const wageTU  = s.payRate*tuHours + Number(md.otherTaxable||0);

    const prevYTD = Number(s.grossYTDSeed||0);
    const ytdAfterAdvWage = prevYTD + wageAdv;
    const ytdAfterTUWage  = ytdAfterAdvWage + wageTU;

    const dc401kAdv = incCap(s.dcPct, s.dcCap, ytdAfterAdvWage, wageAdv);
    const dcCashAdv = incAbove(s.dcPct, s.dcCap, ytdAfterAdvWage, wageAdv);
    const dc401kTU  = incCap(s.dcPct, s.dcCap, ytdAfterTUWage, wageTU);
    const dcCashTU  = incAbove(s.dcPct, s.dcCap, ytdAfterTUWage, wageTU);

    const grossAdv = wageAdv + dcCashAdv;
    const grossTU  = wageTU  + dcCashTU;

    const ytdAfterAdvGross = prevYTD + grossAdv;
    const ytdAfterTUGross  = ytdAfterAdvGross + grossTU;

    const fedAdv = grossAdv * lookupFedRate(grossAdv);
    const fedTU  = grossTU  * lookupFedRate(grossTU);

    const medAdv = grossAdv * s.medRate;
    const medTU  = grossTU  * s.medRate;

    const addMedAdv = incAbove(s.addMedRate, s.addMedThresh, ytdAfterAdvGross, grossAdv);
    const addMedTU  = incAbove(s.addMedRate, s.addMedThresh, ytdAfterTUGross, grossTU);

    const ssAdv = incCap(s.ssRate, s.ssWageBase, ytdAfterAdvGross, grossAdv);
    const ssTU  = incCap(s.ssRate, s.ssWageBase, ytdAfterTUGross, grossTU);

    const unionAdv = (md.unionDues==="Yes") ? grossAdv*s.unionPct : 0;
    const unionTU  = (md.unionDues==="Yes") ? grossTU*s.unionPct : 0;

    const preAdv = s.preTaxPP, preTU = s.preTaxPP;
    const afterEach = Number(s.afterTaxPP||0) + Number(s.afterTaxExtra||0);
    const afterAdv = afterEach, afterTU = afterEach;

    const netAdv = grossAdv - fedAdv - medAdv - addMedAdv - ssAdv - unionAdv - preAdv - afterAdv;
    const netTU  = grossTU  - fedTU  - medTU  - addMedTU  - ssTU  - unionTU  - preTU  - afterTU;

    const month = {gross:grossAdv+grossTU,fed:fedAdv+fedTU,med:medAdv+medTU,addMed:addMedAdv+addMedTU,ss:ssAdv+ssTU,union:unionAdv+unionTU,pre:preAdv+preTU,after:afterAdv+afterTU,dc401k:dc401kAdv+dc401kTU,dcCash:dcCashAdv+dcCashTU,net:netAdv+netTU};
    const ytd = {gross: prevYTD + month.gross, net: Number(s.netYTDSeed||0) + month.net};
    return {adv:{gross:grossAdv,fed:fedAdv,med:medAdv,addMed:addMedAdv,ss:ssAdv,union:unionAdv,pre:preAdv,after:afterAdv,dc401k:dc401kAdv,dcCash:dcCashAdv,net:netAdv},
            tu:{gross:grossTU,fed:fedTU,med:medTU,addMed:addMedTU,ss:ssTU,union:unionTU,pre:preTU,after:afterTU,dc401k:dc401kTU,dcCash:dcCashTU,net:netTU},
            month,ytd,prev:{gross:prevYTD,net:Number(s.netYTDSeed||0)}};
  }

  function renderFinance(s, md, totalHours){
    const f=computeFinance(s, md, totalHours);
    $("netAdvMini").textContent = money(f.adv.net);
    $("netTrueMini").textContent = money(f.tu.net);

    const row=(label,a,t,m,y,p,isNet=false)=>`
      <div class="finGrid ${isNet?'finNet':''}">
        <div class="finCell finLabel">${label}</div>
        <div class="finCell num">${money(a)}</div>
        <div class="finCell num">${money(t)}</div>
        <div class="finCell num">${money(m)}</div>
        <div class="finCell num">${money(y)}</div>
        <div class="finCell num">${money(p)}</div>
      </div>`;

    financeRowsEl.innerHTML =
      row("Gross", f.adv.gross, f.tu.gross, f.month.gross, f.ytd.gross, f.prev.gross) +
      row("Fed", f.adv.fed, f.tu.fed, f.month.fed, 0, 0) +
      row("Medicare", f.adv.med, f.tu.med, f.month.med, 0, 0) +
      row("Add Medicare", f.adv.addMed, f.tu.addMed, f.month.addMed, 0, 0) +
      row("Social Sec.", f.adv.ss, f.tu.ss, f.month.ss, 0, 0) +
      row("Union Dues", f.adv.union, f.tu.union, f.month.union, 0, 0) +
      row("Pre-Tax Deduc.", f.adv.pre, f.tu.pre, f.month.pre, 0, 0) +
      row("After-Tax Deduc.", f.adv.after, f.tu.after, f.month.after, 0, 0) +
      row("DC to 401k", f.adv.dc401k, f.tu.dc401k, f.month.dc401k, 0, 0) +
      row("DC Cash", f.adv.dcCash, f.tu.dcCash, f.month.dcCash, 0, 0) +
      row("NET", f.adv.net, f.tu.net, f.month.net, f.ytd.net, f.prev.net, true);
  }

  const optionsHTML = (codes, sel) => codes.map(c=>{
    const safe=String(c).replace(/"/g,'&quot;');
    return `<option value="${safe}"${c===sel?" selected":""}>${safe}</option>`;
  }).join("");

  function render(){
    const s=loadSettings();
    $("contractYear").value=s.contractYear;
    $("payRate").value=s.payRate;
    $("daily").value=s.daily;
    $("regHours").value=s.regularPayHours;
    $("ovpct").value=s.ovpct;
    $("lrovr").value=s.lrOvr;
    $("otAfter").value=s.otAfterDay;
    $("otPrem").value=s.otPremHours;
    $("vacHrs").value=s.vacHrs;
    $("sickHrs").value=s.sickHrs;
    $("dcPct").value=s.dcPct;
    $("dcCap").value=s.dcCap;
    $("unionPct").value=s.unionPct;
    $("preTaxPP").value=s.preTaxPP;
    $("afterTaxPP").value=s.afterTaxPP;
    $("afterTaxExtra").value=s.afterTaxExtra;
    $("medRate").value=s.medRate;
    $("addMedRate").value=s.addMedRate;
    $("addMedThresh").value=s.addMedThresh;
    $("ssRate").value=s.ssRate;
    $("ssWageBase").value=s.ssWageBase;
    $("grossSeed").value=s.grossYTDSeed;
    $("netSeed").value=s.netYTDSeed;
    $("codeList").value=s.codes.join(",");

    const key=monthSelect.value;
    $("monthTitle").textContent=labelFor(key);

    const md=loadMonth(key);
    shfsSelect.value=md.shfs;
    lrSelect.value=md.lineRotation;
    udSelect.value=md.unionDues;
    otherTaxableInp.value = Number(md.otherTaxable||0).toFixed(2);

    const computed=computeRows(md.rows, s, md);
    rowsEl.innerHTML = computed.map((r,idx)=>`
      <div class="grid row">
        <div class="cell"><span class="datePill">${r.day}</span></div>
        <div class="cell"><select class="codeSel" data-idx="${idx}">${optionsHTML(s.codes,r.code)}</select></div>
        <div class="cell num">${r.count}</div>
        <div class="cell"><input class="baseInp" type="text" inputmode="text" data-idx="${idx}" value="${String(r.base).replace(/"/g,'&quot;')}" placeholder="hh:mm"></div>
        <div class="cell num">${fmt2(r.baseDec)}</div>
        <div class="cell num">${fmt2(r.add25)}</div>
        <div class="cell num">${fmt2(r.ov)}</div>
        <div class="cell num">${fmt2(r.total)}</div>
      </div>
    `).join("");

    rowsEl.querySelectorAll("select.codeSel").forEach(sel=>{
      sel.addEventListener("change",(e)=>{
        const i=Number(e.target.getAttribute("data-idx"));
        const d=loadMonth(monthSelect.value);
        d.rows[i].code=e.target.value;
        saveMonth(monthSelect.value,d);
        render();
      });
    });

    rowsEl.querySelectorAll("input.baseInp").forEach(inp=>{
      inp.addEventListener("blur",(e)=>{
        const i=Number(e.target.getAttribute("data-idx"));
        const d=loadMonth(monthSelect.value);
        d.rows[i].base=e.target.value;
        saveMonth(monthSelect.value,d);
        render();
      });
      inp.addEventListener("keydown",(e)=>{
        if(e.key==="Enter") e.target.blur();
      });
    });

    const totDays = computed.reduce((a,r)=>a+r.count,0);
    const totBase = computed.reduce((a,r)=>a+r.baseHrs,0);
    const totOT   = computed.reduce((a,r)=>a+r.add25,0);
    const totOV   = computed.reduce((a,r)=>a+r.ov,0);
    const totPremOT = computed.reduce((a,r)=>a+r.premOT,0);
    const totTotal= computed.reduce((a,r)=>a+r.total,0);

    $("totDays").textContent=String(totDays);
    $("totBase").textContent=fmt2(totBase);
    $("totOT").textContent=fmt2(totOT);
    $("totOV").textContent=fmt2(totOV);
    $("totTotal").textContent=fmt2(totTotal);

    $("sumRegular").textContent=fmt2(s.regularPayHours);
    $("sumDayAdj").textContent=fmt2(totBase - s.regularPayHours);
    $("sumAddl").textContent=fmt2(totOT);
    $("sumOverride").textContent=fmt2(totOV);
    $("sumPremOT").textContent=fmt2(totPremOT);
    $("sumGrand").textContent=fmt2(totTotal);

    renderFinance(s, md, totTotal);
  }

  function bindSetting(id, key, cast){
    $(id).addEventListener("change",()=>{
      const s=loadSettings();
      s[key]=cast($(id).value);
      saveSettings(s);
      if(key==="contractYear"){
        initMonths(s.contractYear);
        monthSelect.value=keyFor(s.contractYear,1);
      }
      render();
    });
  }

  function doBackup(){
    const s=loadSettings();
    const months=[];
    for(let m=1;m<=12;m++){
      const k=keyFor(s.contractYear,m);
      months.push({key:k, data: loadMonth(k)});
    }
    const payload={app:"CKP_Pay_Hours",version:"final",exportedAt:new Date().toISOString(),settings:s,months};
    const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=`CKP_Pay_Hours_Backup_${s.contractYear}.json`;
    a.click();
  }

  function doRestore(text){
    const payload=JSON.parse(text);
    if(!payload || payload.app!=="CKP_Pay_Hours") throw new Error("Not a CKP Pay Hours backup.");
    if(payload.settings) saveSettings(payload.settings);
    if(Array.isArray(payload.months)){
      payload.months.forEach(item=>{
        if(item && item.key && item.data){
          localStorage.setItem(monthKey(item.key), JSON.stringify(item.data));
        }
      });
    }
    const s=loadSettings();
    initMonths(s.contractYear);
    monthSelect.value=keyFor(s.contractYear,1);
    render();
    alert("Restore complete ✅");
  }

  function exportCSV(){
    const s=loadSettings();
    const k=monthSelect.value;
    const md=loadMonth(k);
    const computed=computeRows(md.rows,s,md);
    let csv="Month,Day,Code,Base_hhmm,Base_dec,CountDay,BaseHours,Add2_5,Override,PremOnOT,TotalHours\n";
    computed.forEach(r=>{
      csv += [
        labelFor(k), r.day,
        `"${String(r.code||"").replace(/"/g,'""')}"`,
        `"${String(r.base||"").replace(/"/g,'""')}"`,
        fmt2(r.baseDec),
        r.count,
        fmt2(r.baseHrs),
        fmt2(r.add25),
        fmt2(r.ov),
        fmt2(r.premOT),
        fmt2(r.total)
      ].join(",") + "\n";
    });
    const blob=new Blob([csv],{type:"text/csv"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=`CKP_Pay_Hours_${k}.csv`;
    a.click();
  }

  // INIT
  const s0=loadSettings();
  initMonths(s0.contractYear);
  monthSelect.value=keyFor(s0.contractYear,1);
  monthSelect.addEventListener("change",render);

  $("resetBtn").addEventListener("click",()=>{
    localStorage.removeItem(monthKey(monthSelect.value));
    render();
  });

  $("backupBtn").addEventListener("click", doBackup);
  $("restoreBtn").addEventListener("click", ()=> $("restoreFile").click());
  $("restoreFile").addEventListener("change", async (e)=>{
    const f=e.target.files && e.target.files[0];
    if(!f) return;
    try{ doRestore(await f.text()); }
    catch(err){ alert("Restore failed: " + (err?.message||String(err))); }
    finally{ e.target.value=""; }
  });

  $("exportBtn").addEventListener("click", exportCSV);

  shfsSelect.addEventListener("change",()=>{const d=loadMonth(monthSelect.value); d.shfs=shfsSelect.value; saveMonth(monthSelect.value,d);});
  lrSelect.addEventListener("change",()=>{const d=loadMonth(monthSelect.value); d.lineRotation=lrSelect.value; saveMonth(monthSelect.value,d); render();});
  udSelect.addEventListener("change",()=>{const d=loadMonth(monthSelect.value); d.unionDues=udSelect.value; saveMonth(monthSelect.value,d); render();});
  otherTaxableInp.addEventListener("change",()=>{const d=loadMonth(monthSelect.value); d.otherTaxable=Number(otherTaxableInp.value||0); saveMonth(monthSelect.value,d); render();});

  bindSetting("contractYear","contractYear",v=>parseInt(v,10)||DEFAULTS.contractYear);
  bindSetting("payRate","payRate",v=>Number(v)||DEFAULTS.payRate);
  bindSetting("daily","daily",v=>Number(v)||DEFAULTS.daily);
  bindSetting("ovpct","ovpct",v=>Number(v)||DEFAULTS.ovpct);
  bindSetting("lrovr","lrOvr",v=>Number(v)||DEFAULTS.lrOvr);
  bindSetting("otAfter","otAfterDay",v=>parseInt(v,10)||DEFAULTS.otAfterDay);
  bindSetting("otPrem","otPremHours",v=>Number(v)||DEFAULTS.otPremHours);
  bindSetting("vacHrs","vacHrs",v=>Number(v)||DEFAULTS.vacHrs);
  bindSetting("sickHrs","sickHrs",v=>Number(v)||DEFAULTS.sickHrs);
  bindSetting("dcPct","dcPct",v=>Number(v)||DEFAULTS.dcPct);
  bindSetting("dcCap","dcCap",v=>Number(v)||DEFAULTS.dcCap);
  bindSetting("unionPct","unionPct",v=>Number(v)||DEFAULTS.unionPct);
  bindSetting("preTaxPP","preTaxPP",v=>Number(v)||DEFAULTS.preTaxPP);
  bindSetting("afterTaxPP","afterTaxPP",v=>Number(v)||DEFAULTS.afterTaxPP);
  bindSetting("afterTaxExtra","afterTaxExtra",v=>Number(v)||DEFAULTS.afterTaxExtra);
  bindSetting("medRate","medRate",v=>Number(v)||DEFAULTS.medRate);
  bindSetting("addMedRate","addMedRate",v=>Number(v)||DEFAULTS.addMedRate);
  bindSetting("addMedThresh","addMedThresh",v=>Number(v)||DEFAULTS.addMedThresh);
  bindSetting("ssRate","ssRate",v=>Number(v)||DEFAULTS.ssRate);
  bindSetting("ssWageBase","ssWageBase",v=>Number(v)||DEFAULTS.ssWageBase);
  bindSetting("grossSeed","grossYTDSeed",v=>Number(v)||DEFAULTS.grossYTDSeed);
  bindSetting("netSeed","netYTDSeed",v=>Number(v)||DEFAULTS.netYTDSeed);

  $("codeList").addEventListener("change",()=>{
    const s=loadSettings();
    const parts=$("codeList").value.split(",").map(x=>x.trim()).filter(Boolean);
    if(parts[0]!== "") parts.unshift("");
    s.codes=parts;
    saveSettings(s);
    render();
  });

  render();
})();
</script>
</body>
</html>
